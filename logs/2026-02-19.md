# 2026-02-19 - Selection & Sentence Improvements

## Goals
- Improve sentence extraction reliability
- Fix selection event handling for better UX

## Decisions

### Intl.Segmenter for Sentence Extraction
- Replaced manual `.!?` scanning with `Intl.Segmenter` API
- Handles abbreviations, quotations, parentheses correctly
- Much simpler and more reliable

### Selection Event Handling
- Switched from `mouseup` + `dblclick` to `selectionchange` event
- Added `pointerdown`/`pointerup` tracking to defer popup until selection is complete
- Added 300ms buffer to prevent popup flickering during rapid selection changes

## Actions

### Sentence Extraction Refactor
- Added `sentenceSegmenter = new Intl.Segmenter('en', { granularity: 'sentence' })`
- Simplified `extractSentence()` from complex tree walking to simple segment matching
- Removed 90+ lines of manual boundary detection code

### Selection Timing Fix
- Replaced `mouseup` + `dblclick` handlers with `selectionchange`
- Removed `getWordUnderCursor()` function (no longer needed)
- Added `isPointerDown` state to track drag selection
- Added `pendingSelectionInfo` to store selection during drag
- Added `lastPopupTime` buffer to prevent flicker
- 80ms delay after `pointerup` before showing popup

## Commits

| Commit | Description |
|--------|-------------|
| `Use Intl.Segmenter for sentence extraction` | Sentence extraction refactor |
| `Use selectionchange event for text selection` | Event handler refactor |
| `Fix selection timing: wait for pointerup and prevent popup flicker` | Timing fixes |

## Current Version
`0.2.5`
