# 2026-02-19 - Selection & Sentence Improvements

## Goals
- Improve sentence extraction reliability
- Fix selection event handling for better UX

## Decisions

### Intl.Segmenter for Sentence Extraction
- Replaced manual `.!?` scanning with `Intl.Segmenter` API
- Handles abbreviations, quotations, parentheses correctly
- Much simpler and more reliable

### Selection Event Handling
- Switched from `mouseup` + `dblclick` to `selectionchange` event
- Added `pointerdown`/`pointerup` tracking to defer popup until selection is complete
- Added 300ms buffer to prevent popup flickering during rapid selection changes

## Actions

### Sentence Extraction Refactor
- Added `sentenceSegmenter = new Intl.Segmenter('en', { granularity: 'sentence' })`
- Simplified `extractSentence()` from complex tree walking to simple segment matching
- Removed 90+ lines of manual boundary detection code

### Selection Timing Fix
- Replaced `mouseup` + `dblclick` handlers with `selectionchange`
- Removed `getWordUnderCursor()` function (no longer needed)
- Added `isPointerDown` state to track drag selection
- Added `pendingSelectionInfo` to store selection during drag
- Added `lastPopupTime` buffer to prevent flicker
- 80ms delay after `pointerup` before showing popup

## Commits

| Commit | Description |
|--------|-------------|
| `Use Intl.Segmenter for sentence extraction` | Sentence extraction refactor |
| `Use selectionchange event for text selection` | Event handler refactor |
| `Fix selection timing: wait for pointerup and prevent popup flicker` | Timing fixes |

## Current Version
`0.2.5`

## Technical Learnings

### Intl.Segmenter

`Intl.Segmenter` is a locale-aware text segmentation API:

```javascript
const segmenter = new Intl.Segmenter('en', { granularity: 'sentence' });
for (const { segment } of segmenter.segment(text)) {
  console.log(segment); // Each sentence
}
```

**Granularity options:**
- `'grapheme'` - visible characters (handles emoji, combining marks)
- `'word'` - word boundaries
- `'sentence'` - sentence boundaries

**Why it's better than regex `.!?` scanning:**
- Handles abbreviations ("Dr.", "vs.", "etc.")
- Handles quotations and parentheses
- Locale-specific rules
- No edge case bugs

### selectionchange Event

`selectionchange` fires on `document` whenever the selection changes:
- During drag selection (continuously)
- After double-click (browser auto-selects word)
- After keyboard selection (Shift+arrows)

**Problem:** Fires too frequently during drag, showing popup mid-selection.

**Solution:** Track `pointerdown`/`pointerup` state and defer popup until `pointerup`.

### Event Ordering During Selection

**Drag selection:**
1. `pointerdown`
2. `selectionchange` (many times during drag)
3. `pointerup`
4. Final `selectionchange`

**Double-click:**
1. `pointerdown` → `pointerup` → `click` (first click)
2. `pointerdown` → `pointerup` → `click` → `dblclick` (second click)
3. `selectionchange` (browser selects word)

**Key insight:** During double-click, `selectionchange` fires after the second `pointerup`, but may fire multiple times with transient states (briefly empty selection). The 300ms buffer prevents hiding the popup during these transient states.
